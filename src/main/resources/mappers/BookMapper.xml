<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.toyproject.bookmanagement.repository.BookRepository">

	<resultMap type="com.toyproject.bookmanagement.entity.Book" id="BookMap">
		<id property="bookId" column="book_id"/>
		<result property="bookName" column="book_name"/>
		<result property="authorId" column="author_id"/>
		<result property="publisherId" column="publisher_id"/>
		<result property="categoryId" column="category_id"/>
		<result property="coverImgUrl" column="cover_img_url"/>
		<result property="likeCount" column="like_count"/>
		
		<association property="author" resultMap="AuthorMap" ></association>
		<association property="publisher" resultMap="PublisherMap" ></association>
		<association property="category" resultMap="CategoryMap" ></association>
	</resultMap>
	
	<resultMap type="com.toyproject.bookmanagement.entity.Author" id="AuthorMap">
		<id property="authorId" column="author_id"/>
		<result property="authorName" column="author_name"/>
	</resultMap>
	
	<resultMap type="com.toyproject.bookmanagement.entity.Publisher" id="PublisherMap">
		<id property="publisherId" column="publisher_id"/>
		<result property="publisherName" column="publisher_name"/>
	</resultMap>
	
	<resultMap type="com.toyproject.bookmanagement.entity.Category" id="CategoryMap">
		<id property="categoryId" column="category_id"/>
		<result property="categoryName" column="category_name"/>
	</resultMap>
	
	<select id="getBook" parameterType="Integer" resultMap="BookMap">
		SELECT
			bt.book_id,
		    bt.book_name,
		    bt.author_id,
		    bt.publisher_id,
		    bt.category_id,
		    bt.cover_img_url,
		    
		    at.author_id,
		    at.author_name,
		    
		    pt.publisher_id,
		    pt.publisher_name,
		    
		    ct.category_id,
		    ct.category_name
		FROM 
			book_tb bt
			LEFT OUTER JOIN author_tb at ON (at.author_id = bt.author_id)
			LEFT OUTER JOIN publisher_tb pt ON (pt.publisher_id = bt.publisher_id)
			LEFT OUTER JOIN category_tb ct ON (ct.category_id = bt.category_id)
		WHERE
			bt.book_id = #{bookId}
	</select>

	<select id="searchBooks" parameterType="hashmap" resultMap="BookMap">
		SELECT
			bt.book_id,
		    bt.book_name,
		    bt.author_id,
		    bt.publisher_id,
		    bt.category_id,
		    bt.cover_img_url,
		    
		    lc.like_count,
		    
		    at.author_id,
		    at.author_name,
		    
		    pt.publisher_id,
		    pt.publisher_name,
		    
		    ct.category_id,
		    ct.category_name
		FROM 
			book_tb bt
			LEFT OUTER JOIN author_tb at ON (at.author_id = bt.author_id)
			LEFT OUTER JOIN publisher_tb pt ON (pt.publisher_id = bt.publisher_id)
			LEFT OUTER JOIN category_tb ct ON (ct.category_id = bt.category_id)
			LEFT OUTER JOIN (SELECT 
											book_id, count(*) AS like_count
										FROM 
											book_like_tb 
										GROUP BY 
											book_id) lc ON(lc.book_id = bt.book_id)
		WHERE
			1 = 1
			<if test="categoryIds != null">
				and bt.category_id in (
					<foreach item="categoryId" collection="categoryIds" separator=",">
						#{categoryId}
					</foreach>
				)
			</if>
			and bt.book_name like concat ("%", #{searchValue}, "%")
		ORDER BY
			bt.book_id
		LIMIT
			#{index}, 20;
	</select>
	
	<select id="getTotalCount" parameterType="hashmap" resultType="Integer">
		SELECT 
			COUNT(*)
		FROM
			book_tb bt
			LEFT OUTER JOIN author_tb at ON (at.author_id = bt.author_id)
			LEFT OUTER JOIN publisher_tb pt ON (pt.publisher_id = bt.publisher_id)
			LEFT OUTER JOIN category_tb ct ON (ct.category_id = bt.category_id)	
		WHERE
			1 = 1
		<if test="categoryIds != null">
			and bt.category_id in (
				<foreach item="categoryId" collection="categoryIds" separator=",">
					#{categoryId}
				</foreach>
			)
		</if>		
		and bt.book_name like concat ("%", #{searchValue}, "%")
	</select>
	
	<select id="getCategories" parameterType="list" resultMap="CategoryMap">
		SELECT
			category_id,
			category_name
		FROM
			category_tb
	</select>
	
	<select id="getLikeCount" parameterType="Integer" resultType="Integer">
		SELECT
			count(*)
		FROM
			book_like_tb
		WHERE
			book_id = #{bookId}
	</select>
	
	<select id="getLikeStatus" parameterType="hashMap" resultType="Integer">
		SELECT
			count(*)
		FROM
			book_like_tb
		WHERE
			book_id = #{bookId}
		and user_id = #{userId}
	</select>
	
</mapper>